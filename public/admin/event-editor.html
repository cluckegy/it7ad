<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محرر الفعاليات - لوحة التحكم</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
        :root {
            --primary-color: #0056b3; --sidebar-bg: #212529; --body-bg: #f4f7f6;
            --card-bg: #ffffff; --text-color: #333; --light-text: #f8f9fa; --success: #28a745;
        }
        body { font-family: 'Cairo', sans-serif; background-color: var(--body-bg); margin: 0; display: flex; }
        .sidebar { width: 250px; background-color: var(--sidebar-bg); color: var(--light-text); display: flex; flex-direction: column; height: 100vh; position: fixed; }
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid #444; }
        .sidebar-nav { flex-grow: 1; list-style: none; padding: 20px 0; margin: 0; }
        .sidebar-nav li a { display: block; padding: 15px 20px; color: var(--light-text); text-decoration: none; }
        .sidebar-nav li a:hover, .sidebar-nav li a.active { background-color: var(--primary-color); }
        .sidebar-nav li a i { margin-left: 10px; }
        .main-content { margin-right: 250px; width: calc(100% - 250px); padding: 20px; }
        .editor-container { background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 20px; }
        .full-width { grid-column: 1 / -1; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        .form-group textarea { min-height: 150px; resize: vertical; }
        .form-actions { margin-top: 20px; text-align: left; }
        .save-btn { background-color: var(--success); color: white; padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: 600; }
        /* New Styles for Image Upload */
        .image-source-toggle { display: flex; align-items: center; margin-bottom: 10px; }
        .toggle-switch { position: relative; display: inline-block; width: 120px; height: 34px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 55px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 20px; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(55px); }
        .toggle-label { margin: 0 10px; font-weight: 600; }
        .custom-file-upload { border: 2px dashed #ccc; display: inline-block; padding: 6px 12px; cursor: pointer; border-radius: 5px; background-color: #f9f9f9; }
        .custom-file-upload:hover { border-color: var(--primary-color); }
        #file-chosen { margin-right: 10px; color: #555; }
    </style>
</head>
<body>
    <aside class="sidebar" id="sidebar-container"></aside>
    <main class="main-content">
        <h1 id="page-title">إنشاء فعالية جديدة</h1>
        <div class="editor-container">
            <form id="event-form">
                <div class="form-group full-width">
                    <label for="title">عنوان الفعالية</label>
                    <input type="text" id="title" name="title" required>
                </div>
                
                <div class="form-group full-width">
                    <label>صورة الغلاف</label>
                    <div class="image-source-toggle">
                        <span class="toggle-label">رابط</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="image_type_toggle">
                            <span class="slider"></span>
                        </label>
                        <span class="toggle-label">رفع</span>
                    </div>
                    <div id="cover_image_url_container">
                        <input type="url" name="cover_image_url" placeholder="https://example.com/image.png">
                    </div>
                    <div id="cover_image_upload_container" style="display: none;">
                        <input type="file" name="cover_image_upload" id="cover_image_upload" accept="image/*" style="display: none;">
                        <label for="cover_image_upload" class="custom-file-upload"><i class="fas fa-upload"></i> اختر صورة</label>
                        <span id="file-chosen">لم يتم اختيار أي ملف</span>
                    </div>
                </div>

                <div class="form-group full-width">
                    <label for="description">الوصف</label>
                    <textarea id="description" name="description" required></textarea>
                </div>
                <div class="form-group full-width">
                    <label for="terms_conditions">الشروط والأحكام (اختياري)</label>
                    <textarea id="terms_conditions" name="terms_conditions"></textarea>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="location">المكان</label>
                        <input type="text" id="location" name="location">
                    </div>
                    <div class="form-group">
                        <label for="max_attendees">الحد الأقصى للحضور (اختياري)</label>
                        <input type="number" id="max_attendees" name="max_attendees" min="1">
                    </div>
                    <div class="form-group">
                        <label for="start_time">تاريخ ووقت البدء</label>
                        <input type="datetime-local" id="start_time" name="start_time" required>
                    </div>
                    <div class="form-group">
                        <label for="end_time">تاريخ ووقت الانتهاء</label>
                        <input type="datetime-local" id="end_time" name="end_time" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="registration_deadline">آخر موعد للتسجيل (اختياري)</label>
                        <input type="datetime-local" id="registration_deadline" name="registration_deadline">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="save-btn">حفظ الفعالية</button>
                </div>
            </form>
        </div>
    </main>

    <script>
        const token = localStorage.getItem('authToken');
        const form = document.getElementById('event-form');
        const pageTitle = document.getElementById('page-title');
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id');
        const isEditMode = eventId !== null;

        // UI elements for image upload
        const imageToggle = document.getElementById('image_type_toggle');
        const urlContainer = document.getElementById('cover_image_url_container');
        const uploadContainer = document.getElementById('cover_image_upload_container');
        const fileInput = document.getElementById('cover_image_upload');
        const fileChosenSpan = document.getElementById('file-chosen');

        document.addEventListener('DOMContentLoaded', () => {
            if (!token) { window.location.href = '/login'; return; }
            loadSidebar();
            if (isEditMode) {
                pageTitle.textContent = 'تعديل الفعالية';
                loadEventForEditing();
            }
        });
        
        // Image toggle logic
        imageToggle.addEventListener('change', () => {
            urlContainer.style.display = imageToggle.checked ? 'none' : 'block';
            uploadContainer.style.display = imageToggle.checked ? 'block' : 'none';
        });

        fileInput.addEventListener('change', () => {
            fileChosenSpan.textContent = fileInput.files.length > 0 ? fileInput.files[0].name : 'لم يتم اختيار أي ملف';
        });


        async function loadEventForEditing() {
            try {
                const res = await fetch(`/api/events/${eventId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error('Failed to fetch event data.');
                
                const event = await res.json();
                
                form.elements['title'].value = event.title;
                form.elements['description'].value = event.description;
                form.elements['terms_conditions'].value = event.terms_conditions;
                form.elements['location'].value = event.location;
                form.elements['max_attendees'].value = event.max_attendees;
                form.elements['start_time'].value = toDateTimeLocal(event.start_time);
                form.elements['end_time'].value = toDateTimeLocal(event.end_time);
                form.elements['registration_deadline'].value = toDateTimeLocal(event.registration_deadline);

                if (event.cover_image_url && event.cover_image_url.startsWith('/uploads/')) {
                    imageToggle.checked = true;
                    fileChosenSpan.textContent = `ملف حالي: ${event.cover_image_url.split('/').pop()}`;
                } else {
                    imageToggle.checked = false;
                    form.elements['cover_image_url'].value = event.cover_image_url;
                }
                imageToggle.dispatchEvent(new Event('change'));

            } catch (error) {
                alert('فشل تحميل بيانات الفعالية.');
                window.location.href = '/admin/events.html';
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            
            if (!imageToggle.checked) {
                formData.delete('cover_image_upload');
            } else {
                formData.delete('cover_image_url');
            }
            
            if(isEditMode) {
                const currentImage = (await (await fetch(`/api/events/${eventId}`, { headers: { 'Authorization': `Bearer ${token}` } })).json()).cover_image_url;
                if(currentImage && !formData.has('cover_image_upload')) {
                     formData.append('existing_cover_image_path', currentImage);
                }
            }


            const apiEndpoint = isEditMode ? `/api/events/${eventId}` : '/api/events';
            const apiMethod = isEditMode ? 'PUT' : 'POST';

            try {
                const res = await fetch(apiEndpoint, {
                    method: apiMethod,
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const result = await res.json();
                alert(result.message);
                if (res.ok) {
                    window.location.href = '/admin/events.html';
                }
            } catch (error) {
                alert('An error occurred. Please try again.');
            }
        });
        
        function toDateTimeLocal(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            return date.toISOString().slice(0, 16);
        }

        function loadSidebar() {
             const sidebarContainer = document.getElementById('sidebar-container');
            sidebarContainer.innerHTML = `
                <div class="sidebar-header"><h3>لوحة التحكم</h3></div>
                <ul class="sidebar-nav">
                    <li><a href="/dashboard.html"><i class="fas fa-tachometer-alt"></i> الرئيسية</a></li>
                    <li><a href="/admin/users.html"><i class="fas fa-users"></i> إدارة المستخدمين</a></li>
                    <li><a href="/admin/content.html"><i class="fas fa-newspaper"></i> إدارة المحتوى</a></li>
                    <li><a href="/admin/events.html" class="active"><i class="fas fa-calendar-alt"></i> إدارة الفعاليات</a></li>
                </ul>`;
        }
    </script>
</body>
</html>

